<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>EPR Plotter</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#111111">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Leaflet (map picking). First load needs internet; app works offline afterward. -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root { --b:#e6e6e6; --pad:12px; --br:14px; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:14px;background:#fff;color:#111}
    h1{margin:0 0 6px 0;font-size:22px}
    .muted{color:#666;font-size:.92rem}
    .grid{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:980px){.grid{grid-template-columns:360px 1fr}}
    .card{border:1px solid var(--b);border-radius:var(--br);padding:var(--pad);background:#fff}
    label{display:block;margin-top:10px;font-weight:700}
    input,select,textarea{
      width:100%;padding:10px;margin-top:6px;box-sizing:border-box;
      border:1px solid var(--b);border-radius:12px;font-size:16px;
    }
    button{width:100%;padding:12px;margin-top:10px;border-radius:12px;border:1px solid var(--b);background:#fff;font-weight:800}
    button:active{transform:scale(.99)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row button{flex:1 1 160px}
    canvas{width:100%;height:360px;border:1px solid var(--b);border-radius:var(--br);background:#fff;touch-action:manipulation}
    .kpi{margin:8px 0;font-size:1.03rem}
    .good{color:#0a7b2e;font-weight:900}
    .warn{color:#b35a00;font-weight:900}
    .bad{color:#b00020;font-weight:900}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--b);border-radius:999px;font-size:.85rem;margin-left:6px}
    hr{border:none;border-top:1px solid #eee;margin:10px 0}
    .small{font-size:.88rem}
    table{border-collapse:collapse}
    th{font-size:.9rem;color:#444}
    td,th{padding:8px;border-bottom:1px solid #f2f2f2;vertical-align:top}
    td input, td select{margin-top:0}
    .tinybtn{width:auto;padding:8px 10px;border-radius:10px;margin-top:0}
    .tag{display:inline-block;padding:2px 8px;border:1px solid #ddd;border-radius:999px;font-size:.82rem;color:#333}
    .right{display:flex;justify-content:flex-end;gap:10px;align-items:center}
    .status{font-size:.85rem;color:#666;margin-top:6px}
    .status strong{color:#111}
  </style>
</head>

<body>
  <h1>EPR Plotter <span class="pill">field app</span></h1>
  <div class="muted">
    Workflow: first GPS lock → set as <b>REF</b>. Enter early points manually (0.1, 1, 2, 3…).
    When far enough to trust GPS, switch row to <b>GPS</b> mode and <b>Sync GPS</b> to stabilise coordinates.
    Distance auto-calculates as straight-line from REF.
  </div>

  <div class="grid" style="margin-top:12px;">
    <div class="card">
      <h3 style="margin:0 0 6px 0;">Inputs</h3>

      <label>Injection current, I<sub>test</sub> (A)</label>
      <input id="itest" type="number" step="0.001" value="2.5">

      <label>Fault current, I<sub>fault</sub> (A)</label>
      <input id="ifault" type="number" step="0.1" value="2210">

      <label>Additional scaling factor (SF)</label>
      <input id="sf" type="number" step="0.001" value="1.0">
      <div class="muted small">Leave 1.0 unless applying split/DF/derating.</div>

      <hr>

      <h3 style="margin:0 0 6px 0;">GPS sync settings</h3>
      <label>Target accuracy (m)</label>
      <input id="gpsTargetAcc" type="number" step="1" value="10">
      <div class="muted small">“Sync GPS” will keep sampling until accuracy ≤ this value (or timeout).</div>

      <label>Max wait time (s)</label>
      <input id="gpsTimeout" type="number" step="1" value="20">

      <hr>

      <label>Remote estimation</label>
      <select id="remoteMode">
        <option value="extrap">Extrapolate V∞ (tail fit: V vs 1/d)</option>
        <option value="avgLastN">Average last N points</option>
        <option value="last">Use last point</option>
      </select>

      <label>N (last-N + checks)</label>
      <input id="nLast" type="number" min="3" max="30" step="1" value="5">

      <label>Tail points (min)</label>
      <input id="tailMin" type="number" min="3" max="30" step="1" value="5">

      <div class="row">
        <button id="btnUpdate">Update</button>
        <button id="btnResetExclude">Clear excludes</button>
      </div>

      <div class="row">
        <button id="btnAddRow">Add row</button>
        <button id="btnAdd5">Add 5 rows</button>
        <button id="btnAdd20">Add 20 rows</button>
      </div>

      <div class="row">
        <button id="btnGpsNewRef">GPS Sync → NEW REF row</button>
        <button id="btnSetRefSelected">Set selected as REF</button>
      </div>

      <div class="row">
        <button id="btnCSV">Download CSV</button>
        <button id="btnExample">Load example</button>
      </div>

      <hr>

      <div class="kpi">Plateau check: <span id="plateau">—</span></div>
      <div class="muted small" id="plateauDetail">—</div>
    </div>

    <div class="card">
      <div class="right">
        <div class="muted small">Selected row: <span id="selRowLabel">none</span></div>
        <div class="muted small">REF: <span id="refLabel">none</span></div>
      </div>

      <h3 style="margin:6px 0 6px 0;">Measurements (table)</h3>
      <div class="muted small">
        Manual = you type distance. GPS = straight-line distance from REF (needs REF lat/lon). Use <b>Sync GPS</b> to improve initial lock.
      </div>

      <div style="overflow:auto; margin-top:10px;">
        <table id="tbl" style="width:100%; min-width:1120px;">
          <thead>
            <tr>
              <th>#</th>
              <th>Select</th>
              <th>Mode</th>
              <th>Distance (m)</th>
              <th>mV</th>
              <th>Lat</th>
              <th>Lon</th>
              <th>GPS tools</th>
              <th>GPS status</th>
              <th>Exclude</th>
            </tr>
          </thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>

      <h3 style="margin:12px 0 6px 0;">Plot</h3>
      <canvas id="plot" width="1100" height="360"></canvas>
      <div class="muted small">Black dots = included points. Red ✕ = excluded points. Curve + checks re-fit using included points only.</div>

      <hr>

      <h3 style="margin:0 0 6px 0;">Results</h3>
      <div class="kpi">Knee distance: <span id="knee">—</span></div>
      <div class="muted small" id="kneeDetail">—</div>

      <hr>

      <div class="kpi">Remote EPR V<sub>∞</sub> (V): <span id="vinf">—</span></div>
      <div class="kpi">R<sub>g,test</sub> (Ω): <span id="rg">—</span></div>
      <div class="muted small" id="fitDetail">—</div>

      <hr>

      <div class="kpi">Scale (I<sub>fault</sub>/I<sub>test</sub> × SF): <span id="scale">—</span></div>
      <div class="kpi">EPR<sub>scaled</sub> (V): <span id="eprscaled">—</span></div>
    </div>
  </div>

  <!-- Map modal -->
  <div id="mapModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); padding:18px; z-index:9999;">
    <div style="background:#fff; border-radius:14px; padding:12px; max-width:980px; margin:0 auto;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <b>Pick GPS point <span class="tag" id="mapRowTag">row ?</span></b>
        <div style="display:flex; gap:10px; align-items:center;">
          <select id="mapLayer" style="width:auto;">
            <option value="esri">Satellite (Esri)</option>
            <option value="osm">Map (OSM)</option>
          </select>
          <button id="btnCloseMap" class="tinybtn">Close</button>
        </div>
      </div>
      <div class="muted small">Tap the map to set lat/lon for the selected row.</div>
      <div id="map" style="height:440px; margin-top:10px; border:1px solid #eee; border-radius:12px;"></div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    if ("serviceWorker" in navigator) navigator.serviceWorker.register("sw.js");
  </script>
</body>
</html>
